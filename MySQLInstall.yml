---
- name: Install MySQL 8.0 on RHEL 9
  hosts: n4
  become: yes
  vars:
    mysql_root_password: "Matilda@123"
    mysql_version: "8.0"

  tasks:
    - name: Install MySQL 8.0 repository
      dnf:
        name: https://dev.mysql.com/get/mysql80-community-release-el9-1.noarch.rpm
        state: present

    - name: Install MySQL 8.0 Server
      dnf:
        name: mysql-server
        state: present

    - name: Start and Enable MySQL service
      systemd:
        name: mysqld
        state: started
        enabled: yes

    - name: Set MySQL root password
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        login_unix_socket: /var/lib/mysql/mysql.sock
        state: present

    - name: Get the temporary MySQL root password
      command: "grep 'temporary password' /var/log/mysqld.log"
      register: mysql_root_temp_password
      changed_when: false

    - name: Secure MySQL installation
      mysql_secure_installation:
        login_user: root
        login_password: "{{ mysql_root_temp_password.stdout.split(' ')[-1] }}"
        root_password: "{{ mysql_root_password }}"
        state: present
        validate_password: no
        remove_test_db: yes
        disallow_empty_password: yes
        change_root_password: yes

    - name: Ensure MySQL service is running
      systemd:
        name: mysqld
        state: started
        enabled: yes
